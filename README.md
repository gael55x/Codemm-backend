# Codem Backend (Codemm)

Express + SQLite backend powering Codem’s agentic activity generation and sandboxed execution/judging via Docker.

## Docs

- Start here: `documentation/README.md`
- Architecture diagrams (Mermaid): `documentation/AGENTIC_PLATFORM.md`

## What’s in this backend

- **SpecBuilder sessions API** (`/sessions`): deterministic agent loop that turns chat into an `ActivitySpec`.
- **Generation pipeline** (`/sessions/:id/generate`): per-slot LLM drafts → schema validation → Docker verification → persist (reference artifacts discarded).
- **Execution/Judge APIs**: `/run` (code-only) and `/submit` (graded w/ tests) run inside Docker judge images.
- **Observability**: generation progress SSE + optional sanitized trace SSE (no prompts/raw generations/reference artifacts).

## Core design (agentic, but deterministic)

Codemm follows a strict boundary:

- **LLM proposes**: intent inference (`inferredPatch`) + per-slot problem drafts.
- **Compiler decides**: Zod contracts, invariants, JSON Patch application, commitment locking, readiness gates, and next-question selection.
- **No direct state mutation by LLM**: persisted state is produced by audited deterministic code paths.

More detail: `documentation/architecture.md`

## Codemm learning modes

Codemm exposes a user-facing **Learning Mode** (pedagogy), without changing safety or verification:

- `practice`: current behavior — generate problems from an `ActivitySpec`
- `guided`: scaffolded, learner-adaptive sequences where the student-facing code is deterministically derived from a fully-correct reference artifact (tests unchanged; reference artifacts discarded before persistence). Optionally, guided mode can also inject short, best-effort hint comments generated by the LLM (this does not affect tests/verification).

Both modes use the same contracts, invariants, retries, and Docker validation.

Guided hint generation can be disabled via `CODEMM_DYNAMIC_GUIDED_HINTS=0`.

## Quickstart (local dev)

Prereqs: Node 18+, npm, Docker Desktop.

1) Configure env:
- `cp .env.example .env`
- Set `CODEX_API_KEY` and `JWT_SECRET` in `.env`

2) Run (recommended one-command runner; builds judge images if needed):
- `./run-codem-backend.sh`

Manual alternative:
- `npm install`
- `npm run dev`

Build + run:
- `npm run build && npm start`

Useful runner toggles:
- `BACKEND_MODE=prod ./run-codem-backend.sh`
- `REBUILD_JUDGE=1 ./run-codem-backend.sh`

## API surface (high level)

Base URL: `http://localhost:${PORT:-4000}`

Sessions (SpecBuilder):
- `POST /sessions` → create a session (`DRAFT`)
- `POST /sessions/:id/messages` → run one agent loop step (returns `nextQuestion`, `questionKey`, `done`)
- `GET /sessions/:id` → debug snapshot (includes `commitments` + `generationOutcomes`)
- `POST /sessions/:id/generate` (auth) → generate + persist an activity
- `GET /sessions/:id/generate/stream` → SSE progress stream
- `GET /sessions/:id/trace` → SSE trace stream (requires `CODEMM_TRACE=1`)

Execution / judge:
- `POST /run` → Docker sandbox execution (code-only or multi-file; no tests)
- `POST /submit` → graded execution (requires `testSuite`)
- `GET /activities/:id` (auth) → fetch persisted activity (problems include `language`)

Auth / profile:
- `POST /auth/register`, `POST /auth/login`, `GET /auth/me`
- `GET /profile` (auth)

Full details + examples: `documentation/api.md`

## Debug tracing

- Enable trace events: `CODEMM_TRACE=1`
- Stream trace events (SSE): `GET /sessions/:id/trace`
- Include generator test suite snippets (debug only): `CODEMM_TRACE_TEST_SUITES=1`

Note: trace/progress streams intentionally omit prompts, raw generations, and reference artifacts.

## Env safety (recommended)

If you ever plan to commit environment values, use dotenvx precommit:
- https://dotenvx.com/precommit
